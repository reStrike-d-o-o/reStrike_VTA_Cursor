<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>reStrike VTA - Player Introduction Overlay</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: transparent;
            font-family: Arial, sans-serif;
        }
        
        #overlay-container {
            width: 1920px;
            height: 1080px;
            position: relative;
        }
        
        #overlay-svg {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        /* Connection status indicator */
        .connection-status {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ef4444;
            border: 2px solid #ffffff;
            z-index: 1000;
        }
        
        .connection-status.connected {
            background: #10b981;
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div id="connection-status" class="connection-status"></div>
    
    <!-- Overlay Container -->
    <div id="overlay-container">
        <object id="overlay-svg" data="assets/scoreboard/player-introduction-overlay.svg" type="image/svg+xml">
            <!-- Fallback content if SVG fails to load -->
            <div style="width: 1920px; height: 1080px; background: #000; color: white; display: flex; align-items: center; justify-content: center; font-size: 48px;">
                Player Introduction Overlay Loading...
            </div>
        </object>
    </div>

    <!-- JavaScript Utilities -->
    <script src="assets/scoreboard/scoreboard-name-utils.js"></script>
    <script src="assets/scoreboard/scoreboard-utils.js"></script>
    
    <!-- PSS Event Integration Script -->
    <script>
        // Global variables
        let overlayInstance = null;
        let nameManager = null;
        let isConnected = false;
        
        // Initialize the overlay when SVG loads
        function initializeOverlay() {
            const svgObject = document.getElementById('overlay-svg');
            const svgDoc = svgObject.contentDocument || svgObject.contentWindow?.document;
            
            if (svgDoc && svgDoc.querySelector('svg')) {
                console.log('üéØ Player Introduction overlay loaded, initializing...');
                
                // Initialize overlay utilities
                overlayInstance = new PlayerIntroductionOverlay(svgDoc.querySelector('svg'));
                nameManager = new ScoreboardNameManager();
                
                // Set initial state
                updateConnectionStatus(false);
                
                console.log('‚úÖ Player Introduction overlay initialized successfully');
            } else {
                console.error('‚ùå Failed to load SVG document');
                setTimeout(initializeOverlay, 1000); // Retry after 1 second
            }
        }
        
        // Update connection status indicator
        function updateConnectionStatus(connected) {
            isConnected = connected;
            const statusElement = document.getElementById('connection-status');
            
            if (connected) {
                statusElement.classList.add('connected');
            } else {
                statusElement.classList.remove('connected');
            }
        }
        
        // Handle PSS events from Tauri
        function handlePssEvent(event) {
            console.log('üì° Received PSS event:', event);
            
            if (!overlayInstance) {
                console.warn('‚ö†Ô∏è Overlay not initialized, ignoring event');
                return;
            }
            
            try {
                // Update connection status
                updateConnectionStatus(true);
                
                // Handle different event types
                switch (event.type) {
                    case 'athletes':
                        handleAthletesEvent(event);
                        break;
                    case 'match_config':
                        handleMatchConfigEvent(event);
                        break;
                    case 'fight_loaded':
                        handleFightLoadedEvent(event);
                        break;
                    default:
                        console.log('üìù Unhandled event type:', event.type);
                }
                
            } catch (error) {
                console.error('‚ùå Error handling PSS event:', error);
            }
        }
        
        // Handle athletes event
        function handleAthletesEvent(event) {
            console.log('üë• Updating athletes:', event);
            
            // Update player names - use iocCode if available, otherwise use country code
            if (event.athlete1_long) {
                const countryCode = event.athlete1_iocCode || event.athlete1_country || '';
                overlayInstance.updateLeftPlayer(event.athlete1_long, countryCode, '');
            }
            
            if (event.athlete2_long) {
                const countryCode = event.athlete2_iocCode || event.athlete2_country || '';
                overlayInstance.updateRightPlayer(event.athlete2_long, countryCode, '');
            }
        }
        
        // Handle match config event
        function handleMatchConfigEvent(event) {
            console.log('üèÜ Updating match config:', event);
            
            if (event.category) {
                overlayInstance.updateElement('matchCategory', event.category);
            }
            
            if (event.weight) {
                overlayInstance.updateElement('matchWeight', event.weight);
            }
        }
        
        // Handle fight loaded event
        function handleFightLoadedEvent(event) {
            console.log('ü•ä Fight loaded event:', event);
            updateConnectionStatus(true);
        }
        
        // WebSocket connection for real-time PSS events
        let websocket = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectDelay = 2000;
        
        function setupWebSocketConnection() {
            console.log('üîó Setting up WebSocket connection...');
            
            try {
                // Get WebSocket URL from current location or use default
                const currentHost = window.location.hostname;
                const wsHost = currentHost === 'localhost' || currentHost === '127.0.0.1' ? '127.0.0.1' : currentHost;
                const wsUrl = `ws://${wsHost}:3001`;
                
                console.log(`üîó Connecting to WebSocket server at: ${wsUrl}`);
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function(event) {
                    console.log('‚úÖ WebSocket connected to reStrike VTA server');
                    updateConnectionStatus(true);
                    reconnectAttempts = 0;
                    
                    // Send ping to keep connection alive
                    setInterval(() => {
                        if (websocket.readyState === WebSocket.OPEN) {
                            websocket.send('ping');
                        }
                    }, 30000);
                };
                
                websocket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        console.log('üì° WebSocket message received:', data);
                        
                        if (data.type === 'pss_event') {
                            console.log('üéØ PSS event received via WebSocket:', data.data.type);
                            handlePssEvent(data.data);
                        } else if (data.type === 'connection') {
                            console.log('üîó Connection confirmed:', data.message);
                        }
                    } catch (error) {
                        console.error('‚ùå Error parsing WebSocket message:', error);
                    }
                };
                
                websocket.onclose = function(event) {
                    console.log('üîå WebSocket connection closed');
                    updateConnectionStatus(false);
                    
                    // Attempt to reconnect
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        console.log(`üîÑ Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`);
                        setTimeout(setupWebSocketConnection, reconnectDelay);
                    } else {
                        console.error('‚ùå Max reconnection attempts reached, falling back to localStorage');
                        setupFallbackEventSystem();
                    }
                };
                
                websocket.onerror = function(error) {
                    console.error('‚ùå WebSocket error:', error);
                    updateConnectionStatus(false);
                };
                
            } catch (error) {
                console.error('‚ùå Failed to setup WebSocket connection:', error);
                setupFallbackEventSystem();
            }
        }
        
        // Fallback event system for testing
        function setupFallbackEventSystem() {
            console.log('üîÑ Setting up fallback event system...');
            
            // Listen for custom events (for testing)
            window.addEventListener('pss-event', (event) => {
                console.log('üì° Fallback PSS event received:', event.detail);
                handlePssEvent(event.detail);
            });
            
            // Simulate connection for testing
            setTimeout(() => {
                updateConnectionStatus(true);
                console.log('‚úÖ Fallback event system ready');
            }, 2000);
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Player Introduction overlay page loaded');
            
            // Initialize overlay when SVG loads
            const svgObject = document.getElementById('overlay-svg');
            svgObject.addEventListener('load', initializeOverlay);
            
            // Setup WebSocket connection for real-time PSS events
            setupWebSocketConnection();
            
            // Initialize immediately if SVG is already loaded
            if (svgObject.contentDocument) {
                initializeOverlay();
            }
        });
        
        // Export functions for external access
        window.PlayerIntroductionManager = {
            handlePssEvent,
            updateConnectionStatus,
            overlayInstance: () => overlayInstance,
            nameManager: () => nameManager
        };
        
        console.log('üéØ Player Introduction overlay script loaded');
    </script>
</body>
</html> 